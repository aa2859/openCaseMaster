
@using openCaseMaster.Models;

@model M_testCase
           
 <input id="scriptID" type="hidden" value="@Model.ID" />
<div class="easyui-panel" style="margin-bottom:5px">
    <a href="javascript:void(0)" id="mb" class="easyui-menubutton" style="width:100px"
       data-options="menu:'#C1',iconCls:'icon-edit'">编辑</a>
    <div id="C1" style="width:150px;">
        <div data-options="iconCls:'icon-save'" onclick="scriptSave();">保存</div>
        <div class="menu-sep"></div>
        <div data-options="iconCls:'icon-edit'" onclick="editStepClick($('#scriptTree').tree('getSelected'));">编辑步骤</div>
        <div data-options="iconCls:'icon-add'">
            <span>新增步骤</span>
            <div>
                <div>上一步</div>
                <div>下一步</div>
            </div>
        </div>
        <div data-options="iconCls:'icon-remove'" onclick="DeleteStep();">删除步骤</div>
    </div>
    <a href="javascript:void(0)" id="mb" class="easyui-menubutton" style="width:100px"
       data-options="menu:'#C2',iconCls:'icon-tip'">操作</a>
    <div id="C2" style="width:150px;">
        <div data-options="iconCls:'icon-box_add'" onclick="">自定义组件</div>
        <div class="menu-sep"></div>
        <div data-options="iconCls:'icon-media_controls_dark_play'" onclick="">执行案例</div>
        <div data-options="iconCls:'icon-undo'" onclick="refreshScrpt($(scriptID).val())">撤销所有操作</div>
    </div>
</div>

<ul id="scriptTree"></ul>



<!-- Modal -->
<!-- 模态框（Modal） -->
<div class="modal fade" data-backdrop="static" id="scriptModal" tabindex="-1" role="dialog">

</div>

    <script type="text/javascript">
        //@@ sourceURL=scriptView.js
        var data = @Html.Raw(Model.getScript2Json());
        $('#scriptTree').tree({
            data:data,
            dnd:true,
            checkbox:true,
            pointType:["top","top","bottom","bottom"],
            animate:true,
            lines:true,
            formatter:function(node){
                if(node.Key==undefined)
                    return  node.name +" : "+node.desc;
                else
                    return  node.Key +" : <span style='color:blue'>"+node.Value+"</span>";
            },
            onBeforeDrag:function(node){
                if($("#scriptTree").tree("getParent",node.target))
                    return false;

            },
            onDragOver:function(target, source){
                if($("#scriptTree").tree("getParent",target))
                    return false;
            },
            onDblClick: function (node) {
                editStepClick(node);
            },
        });

        function editStepClick(node)
        {
            if(node===null) return;
    
            if(!$("#scriptTree").tree("getParent",node.target))
            {
                var pd={};
                pd["desc"] = node.desc;
                pd["name"] = node.name;

                for (n in node.children)
                {
                    var nd = node.children[n];
                    pd["ParamBinding["+n+"].name"] = nd.Key;
                    pd["ParamBinding["+n+"].value"] = nd.Value;
                }

                $("#scriptModal").load('EditStep',pd,function() {
                    //combox 和 bootstrap 样式统一
                    $.parser.parse($(".modal-body"));
                    $(".modal-body  .combo").each(function () {
                        $(this).css('width', '100%');
                        $(this).children("input").css('width', '100%');
                        //$(this).children("input").addClass("form-control");
                            
                    });
                    $(function () { $(".modal-body [data-toggle='tooltip']").tooltip(); });
                        

                    $('#scriptModal').modal();
                });
                    

            }
        }


        function scriptSave()
        {
            var nodes= $('#scriptTree').tree("getRoots");
            var steps=[];

            var n;
            for (n in nodes )
            {
                var step = {};
                var node = nodes[n];
                var p = {};
                for (c in node.children)
                {
                    var child = node.children[c];
                    p[child.Key] = child.Value;
                }
                step["desc"] = node.desc;
                step["ParamBinding"] = p;
                step["name"] = node.name;
                steps.push(step);
            }

            $.post("/TestCase/editScript/"+$('#scriptID').val(), { steps: JSON.stringify(steps)  }, function (result) {
                if (result == "True") {
                    $.messager.alert('Messager', '脚本保存成功!', "info");
                }
            }).error(function() { alert("error"); });

        }

        function DeleteStep()
        {
            var node= $('#scriptTree').tree("getSelected");
            if(node)
            {
                var msg = ' <span style=\'color:blue\'>' + node.desc + '</span>';
                $.messager.confirm('Message', '确认删除步骤:' + msg + '?', function (r) {
                    if (r) {
                        $('#scriptTree').tree("remove",node.target);
                    }
                });
            }
        }

        function refreshScrpt(ID)
        {
            $.messager.confirm('Message', '确认撤销所有案例编辑操作吗?', function (r) {
                if (r) 
                    $('#scriptPanel').panel('refresh', 'scriptView/' + ID);
            });
        }
        
    </script>
